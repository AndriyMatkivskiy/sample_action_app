name: PR Checks Monitor

permissions:
  contents: read
  checks: read
  pull-requests: write
  statuses: read

on:
  workflow_run:
    workflows: ["Lint check", "Format check", "Unit Tests"]
    types: [completed]

jobs:
  pr-checks-monitor:
    name: PR Checks Monitor
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.event == 'pull_request' }}

    steps:
      - name: Process PR checks and update status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowRun = context.payload.workflow_run;
            console.log(`ğŸ”„ Starting PR checks monitor...`);
            console.log(`ğŸ“‹ Triggered by: ${workflowRun.name}`);
            console.log(`ğŸŒ¿ Head branch: ${workflowRun.head_branch}`);
            console.log(`âœ… Workflow conclusion: ${workflowRun.conclusion}`);
            
            // Step 1: Find the PR for this branch
            console.log(`ğŸ” Step 1: Looking for PR on branch ${workflowRun.head_branch}...`);
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${workflowRun.head_branch}`,
              state: 'open'
            });
            
            if (prs.data.length === 0) {
              console.log(`âŒ No open PR found for branch ${workflowRun.head_branch}`);
              return;
            }
            
            const pr = prs.data[0];
            console.log(`âœ… Found PR #${pr.number}: "${pr.title}"`);
            console.log(`ğŸ·ï¸  PR state: ${pr.draft ? 'Draft' : 'Ready for Review'}`);
            console.log(`ğŸ”— PR URL: ${pr.html_url}`);
            
            // Step 2: Get all check runs for the PR's head SHA
            console.log(`ğŸ” Step 2: Fetching all check runs for SHA ${pr.head.sha}...`);
            const checkRuns = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            console.log(`ğŸ“Š Found ${checkRuns.data.check_runs.length} check runs`);
            
            // Step 3: Analyze check statuses
            console.log(`ğŸ” Step 3: Analyzing check statuses...`);
            let allPassed = true;
            const checkSummary = {};
            
            for (const check of checkRuns.data.check_runs) {
              console.log(`ğŸ“‹ Check: "${check.name}" - Status: ${check.status}, Conclusion: ${check.conclusion}`);
              
              checkSummary[check.name] = {
                status: check.status,
                conclusion: check.conclusion
              };
              
              // Check if this check is still pending/in progress or failed
              if (check.status !== 'completed' || (check.conclusion !== 'success' && check.conclusion !== 'neutral' && check.conclusion !== 'skipped')) {
                console.log(`âŒ Check "${check.name}" is not successful (status: ${check.status}, conclusion: ${check.conclusion})`);
                allPassed = false;
              } else {
                console.log(`âœ… Check "${check.name}" passed`);
              }
            }
            
            console.log(`ğŸ“Š Check summary:`, JSON.stringify(checkSummary, null, 2));
            
            // Step 4: Get commit statuses as well (for external CI)
            console.log(`ğŸ” Step 4: Fetching commit statuses for SHA ${pr.head.sha}...`);
            const statuses = await github.rest.repos.listCommitStatusesForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            console.log(`ğŸ“Š Found ${statuses.data.length} commit statuses`);
            
            for (const status of statuses.data) {
              console.log(`ğŸ“‹ Status: "${status.context}" - State: ${status.state}`);
              
              if (status.state === 'pending' || status.state === 'error' || status.state === 'failure') {
                console.log(`âŒ Status "${status.context}" is not successful (state: ${status.state})`);
                allPassed = false;
              } else {
                console.log(`âœ… Status "${status.context}" passed`);
              }
            }
            
            // Step 5: Decision making
            console.log(`ğŸ” Step 5: Making decision...`);
            console.log(`ğŸ¯ All checks passed: ${allPassed}`);
            console.log(`ğŸ“ PR is draft: ${pr.draft}`);
            
            if (!allPassed) {
              console.log(`â³ Skipping PR update - not all checks have passed yet`);
              return;
            }
            
            if (!pr.draft) {
              console.log(`â„¹ï¸  PR #${pr.number} is already ready for review - nothing to do`);
              return;
            }
            
            // Step 6: Update PR to ready for review
            console.log(`ğŸš€ Step 6: All checks passed and PR is in draft - marking as ready for review...`);
            
            try {
              console.log(`ğŸ” Using GraphQL API to update PR draft status...`);
              console.log(`ğŸ“ PR node ID: ${pr.node_id}`);
              
              const mutation = `
                mutation MarkPullRequestReadyForReview($pullRequestId: ID!) {
                  markPullRequestReadyForReview(input: {pullRequestId: $pullRequestId}) {
                    pullRequest {
                      id
                      number
                      isDraft
                      url
                    }
                  }
                }
              `;
              
              const result = await github.graphql(mutation, {
                pullRequestId: pr.node_id
              });
              
              console.log(`âœ… GraphQL mutation successful`);
              console.log(`ğŸ” Result:`, JSON.stringify(result, null, 2));
              
              const updatedPr = result.markPullRequestReadyForReview.pullRequest;
              console.log(`ğŸ” Updated PR #${updatedPr.number} - isDraft: ${updatedPr.isDraft}`);
              
              if (!updatedPr.isDraft) {
                console.log(`ğŸ‰ SUCCESS: PR #${pr.number} has been marked as ready for review!`);
                console.log(`ğŸ”— PR URL: ${updatedPr.url}`);
              } else {
                console.log(`âš ï¸  WARNING: GraphQL mutation succeeded but PR is still in draft state`);
              }
              
            } catch (error) {
              console.log(`âŒ ERROR: Failed to update PR #${pr.number} via GraphQL:`, error.message);
              console.log(`ğŸ” Error details:`, JSON.stringify(error, null, 2));
              
              // Fallback to REST API
              console.log(`ğŸ”„ Trying REST API as fallback...`);
              try {
                const restResult = await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  draft: false
                });
                console.log(`âœ… REST API fallback successful. Status: ${restResult.status}`);
              } catch (restError) {
                console.log(`âŒ REST API fallback also failed:`, restError.message);
                throw restError;
              }
            }
